digraph E_TICARET_ODEME_SISTEMI {
    // Graf Ayarları
    rankdir=TB; // Akış Yönü: Yukarıdan Aşağıya
    node [shape=box, style="filled", fillcolor="lightblue", fontname="Arial"];
    
    // Şekil Tanımları (Düğümler)
    start_node [shape=oval, label="BAŞLA", fillcolor="palegreen"];
    end_node [shape=oval, label="BİTİR", fillcolor="red"];

    // 1. Kullanıcı Oturumu ve Sepet
    process_oturumu_ac [shape=box, label="Kullanıcı Oturumu Kontrolü\nSepet Verilerini Yükle"];
    
    // 2. Sepet Yönetim Döngüsü
    loop_sepet_yonetim [shape=diamond, label="DÖNGÜ: İşlem Seçimi Tamamlandı mı?", fillcolor="yellow"];
    input_secim [shape=box, label="KULLANICIDAN_GIRIS_AL()"];
    
    // Ürün Ekleme (Seçim 1)
    process_urun_ekle [shape=box, label="Ürün ID ve Adet Al"];
    decision_stok_yeterli [shape=diamond, label="KOŞUL: ADET <= STOK?", fillcolor="yellow"];
    process_sepet_ekle [shape=box, label="SEPETE_URUN_EKLE()"];
    process_stok_hata [shape=box, label="HATA: Yeterli Stok Yok"];

    // Sepet Düzenle (Seçim 2)
    process_sepet_duzenle [shape=box, label="SEPET_DETAYLARINI_GOSTER()\nKullanıcı Düzenleme Yapar"];
    
    // Ödeme Adımına Geç (Seçim 3)
    process_odemeye_gec [shape=box, label="ISLEM_SECIM_TAMAMLANDI = DOĞRU"];
    
    // 3. Kontroller Öncesi
    decision_sepet_bos [shape=diamond, label="KOŞUL: SEPET_BOS_MU()?", fillcolor="salmon"];
    process_bilgi_al [shape=box, label="ADRES_BILGILERI AL\nSEPET_TUTARI HESAPLA"];
    
    // 3.1. Kargo ve İndirim
    process_kargo_hesapla [shape=box, label="KONTROL NOKTASI: KARGO_HESAPLA()\nGENEL_TOPLAM = Sepet + Kargo"];
    input_indirim [shape=box, label="İndirim Kodu Al"];
    decision_indirim_gecerli [shape=diamond, label="KOŞUL: İndirim Kodu Geçerli mi?", fillcolor="yellow"];
    process_indirim_uygula [shape=box, label="GENEL_TOPLAM = GENEL_TOPLAM - İndirim\nEKRANA_YAZ('İndirim Uygulandı')"];
    process_indirim_hata [shape=box, label="HATA: İndirim Kodu Geçersiz"];

    // 3.2. Nihai Onay ve Son Kontroller
    process_odeme_secim [shape=box, label="Nihai Tutarı Göster\nODEME_YONTEMI Seç"];
    
    // KONTROL NOKTASI: Son Stok Kontrolü
    decision_son_stok [shape=diamond, label="KOŞUL: STOKLAR_YETERLI_MI()?", fillcolor="salmon"];
    process_son_stok_hata [shape=box, label="HATA: Stok Tükendi. İşlem İptal."];

    // 3.3. Ödeme İşlemi
    process_odeme_bilgisi [shape=box, label="ODEME_BILGISI AL"];
    
    // KONTROL NOKTASI: Ödeme Başarısı
    process_odeme_gonder [shape=box, label="ODEME_AG_GECIDINE_GÖNDER()"];
    decision_odeme_basarili [shape=diamond, label="KOŞUL: Ödeme Başarılı mı?", fillcolor="yellowgreen"];
    
    // Başarılı ve Başarısız Sonuçlar
    process_siparis_olustur [shape=box, label="SİPARİS_OLUSTUR()\nSTOKLARI_GUNCELLE()\nSEPETI_TEMIZLE()"];
    process_odeme_hata [shape=box, label="HATA: Ödeme Başarısız Oldu"];

    // Akış Bağlantıları (Kenarlar)

    start_node -> process_oturumu_ac;
    process_oturumu_ac -> loop_sepet_yonetim;

    // Sepet Döngüsü İçindeki Akış
    loop_sepet_yonetim -> input_secim [label="Hayır"];
    loop_sepet_yonetim -> decision_sepet_bos [label="Evet"];
    
    // Seçim Yönlendirmeleri
    input_secim -> process_urun_ekle [label="1 (Ekle)"];
    input_secim -> process_sepet_duzenle [label="2 (Düzenle)"];
    input_secim -> process_odemeye_gec [label="3 (Ödeme)"];
    input_secim -> loop_sepet_yonetim [label="Diğer (Geçersiz)"];

    // Ürün Ekleme Akışı
    process_urun_ekle -> decision_stok_yeterli;
    decision_stok_yeterli -> process_sepet_ekle [label="Evet"];
    decision_stok_yeterli -> process_stok_hata [label="Hayır"];
    process_sepet_ekle -> loop_sepet_yonetim;
    process_stok_hata -> loop_sepet_yonetim;

    // Sepet Düzenleme Akışı
    process_sepet_duzenle -> loop_sepet_yonetim;

    // Ödeme Adımları Akışı
    process_odemeye_gec -> decision_sepet_bos;
    
    // Sepet Boş Kontrolü
    decision_sepet_bos -> process_bilgi_al [label="Hayır"];
    decision_sepet_bos -> end_node [label="Evet"];

    // Kargo ve İndirim Akışı
    process_bilgi_al -> process_kargo_hesapla;
    process_kargo_hesapla -> input_indirim;
    input_indirim -> decision_indirim_gecerli;

    // İndirim Karar Ağacı
    decision_indirim_gecerli -> process_indirim_uygula [label="Evet"];
    decision_indirim_gecerli -> process_indirim_hata [label="Hayır"];
    process_indirim_uygula -> process_odeme_secim;
    process_indirim_hata -> process_odeme_secim; // İndirim hatası ödemeyi durdurmaz

    // Son Kontroller
    process_odeme_secim -> decision_son_stok;
    
    // Son Stok Kontrolü
    decision_son_stok -> process_odeme_bilgisi [label="Evet"];
    decision_son_stok -> process_son_stok_hata [label="Hayır"];
    process_son_stok_hata -> end_node;

    // Ödeme İşlemi
    process_odeme_bilgisi -> process_odeme_gonder;
    process_odeme_gonder -> decision_odeme_basarili;

    // Ödeme Sonuçları
    decision_odeme_basarili -> process_siparis_olustur [label="Başarılı"];
    decision_odeme_basarili -> process_odeme_hata [label="Başarısız"];

    // Bitiş Akışı
    process_siparis_olustur -> end_node;
    process_odeme_hata -> end_node;
}
